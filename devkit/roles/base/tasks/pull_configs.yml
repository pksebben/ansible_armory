---
- name: Pull Configs
  block:
    - name: Ensure .config exists
      file:
        state: directory
        path: "/home/{{ user }}/.config"
        owner: "{{ user }}"
        group: "{{ user }}"
        mode: 0755

    - name: Pull configs from github
      become: yes
      become_user: "{{ user }}"
      git:
        repo: "{{ user_github_account }}/configurations"
        dest: "/home/{{ user }}/.config/configurations"
        accept_hostkey: yes

    - name: Symlink .emacs
      file:
        state: link
        src: "/home/{{ user }}/.config/configurations/.emacs"
        dest: "/home/{{ user }}/.emacs"
        owner: "{{ user }}"
        force: yes

    - name: Symlink .zshrc
      file:
        state: link
        src: "/home/{{ user }}/.config/configurations/.zshrc"
        dest: "/home/{{ user }}/.zshrc"
        owner: "{{ user }}"
        force: yes

    - name: Get p10k
      git:
        repo: https://github.com/romkatv/powerlevel10k.git
        dest: "/home/{{ user }}/.sources/p10k"

    - name: Fix p10k ref in zshrc
      ansible.builtin.lineinfile:
        path: "~/.config/configurations/zshrc"
        line: "source ~/p10k/powerlevel10k.zsh-theme"
        # TODO: fix configs to use distro like ansible calls it

    - name: Set up cron for configs on reboot
      cron:
        name: "push config"
        job: "/home/{{ user }}/.config/configurations/cronpush.sh"
        special_time: reboot
        user: "{{ user }}"

    - name: Set up cron for configs nightly
      cron:
        name: "push config"
        job: "/home/{{ user }}/.config/configurations/cronpush.sh"
        hour: "3"
        minute: "0"
        user: "{{ user }}"
